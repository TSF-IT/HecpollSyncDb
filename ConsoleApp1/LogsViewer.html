<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Hecpoll Logs Viewer</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 1rem;
            background: #f5f5f5;
        }

        h1 {
            margin-top: 0;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
            padding: 0.75rem;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

            .controls > div {
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
            }

        input[type="file"] {
            max-width: 300px;
        }

        input[type="text"] {
            padding: 0.35rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            min-width: 250px;
        }

        .checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem 1rem;
        }

            .checkboxes label {
                font-size: 0.9rem;
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
            }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #ffffff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        thead {
            background: #f0f0f0;
        }

        th, td {
            padding: 0.4rem 0.5rem;
            font-size: 0.85rem;
            border-bottom: 1px solid #eee;
            text-align: left;
            vertical-align: top;
        }

        th {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

            th.sort-asc::after {
                content: " ▲";
                font-size: 0.7rem;
            }

            th.sort-desc::after {
                content: " ▼";
                font-size: 0.7rem;
            }

        tbody tr:nth-child(even) {
            background: #fafafa;
        }

        tbody tr:hover {
            background: #f2f7ff;
        }

        .level {
            font-weight: 600;
            padding: 0.15rem 0.35rem;
            border-radius: 4px;
            display: inline-block;
            font-size: 0.75rem;
        }

        .level-NEW-DRYRUN,
        .level-NEW-INSERT {
            background: #e0f8e9;
            color: #14632a;
        }

        .level-SKIP-OLD {
            background: #fff5e0;
            color: #8a5a00;
        }

        .level-WARN {
            background: #ffe4e6;
            color: #9f1239;
        }

        .level-INFO,
        .level-SUMMARY {
            background: #e5e7eb;
            color: #374151;
        }

        .raw {
            font-family: "Consolas", "SF Mono", ui-monospace, monospace;
            font-size: 0.78rem;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .no-data {
            margin-top: 1rem;
            color: #777;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <h1>Hecpoll Logs Viewer</h1>

    <div class="controls">
        <div>
            <label for="fileInput"><strong>Fichiers de logs (.log)</strong></label>
            <input id="fileInput" type="file" multiple accept=".log,.txt" />
        </div>
        <div>
            <label for="filterText"><strong>Filtre texte (Trans, Date, Station, etc.)</strong></label>
            <input id="filterText" type="text" placeholder="Ex: Trans=316, Term=9, StationID=5..." />
        </div>
        <div>
            <span><strong>Types d'événements</strong></span>
            <div class="checkboxes" id="filterLevels">
                <!-- rempli dynamiquement -->
            </div>
        </div>
    </div>

    <div id="tableContainer"></div>

    <script>
    const fileInput = document.getElementById('fileInput');
    const filterTextInput = document.getElementById('filterText');
    const filterLevelsContainer = document.getElementById('filterLevels');
    const tableContainer = document.getElementById('tableContainer');

    let allEvents = [];      // { level, file, message, fields: {key:val}, raw }
    let visibleLevels = new Set();
    let currentSort = { column: 'level', direction: 'asc' };

    fileInput.addEventListener('change', handleFiles);
    filterTextInput.addEventListener('input', renderTable);

    async function handleFiles(evt) {
      const files = Array.from(evt.target.files || []);
      if (!files.length) return;

      allEvents = [];
      visibleLevels = new Set();
      filterLevelsContainer.innerHTML = '';
      tableContainer.innerHTML = '';

      for (const file of files) {
        const text = await file.text();
        parseLog(text, file.name);
      }

      buildLevelFilters();
      renderTable();
    }

    function parseLog(text, fileName) {
      const lines = text.split(/\r?\n/);
      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed.startsWith('[')) continue; // on ne garde que les lignes de type [XXX]

        // Exemple : [NEW-DRYRUN] Trans=... Date=...
        const match = trimmed.match(/^\[(?<level>[A-Z-]+)\]\s*(?<rest>.*)$/);
        if (!match) continue;

        const level = match.groups.level;
        const rest = match.groups.rest || '';

        const event = {
          level,
          file: fileName,
          message: rest,
          fields: {},
          raw: trimmed
        };

        // Extraire les champs type key=value séparés par virgules
        if (rest.includes('Trans=') || rest.includes('Date=')) {
          const parts = rest.split(',').map(p => p.trim());
          for (const part of parts) {
            const eqIdx = part.indexOf('=');
            if (eqIdx === -1) continue;
            const key = part.substring(0, eqIdx).trim();
            const val = part.substring(eqIdx + 1).trim();
            event.fields[key] = val;
          }
        }

        allEvents.push(event);
        visibleLevels.add(level);
      }
    }

    function buildLevelFilters() {
      filterLevelsContainer.innerHTML = '';
      const levels = Array.from(visibleLevels).sort();
      levels.forEach(level => {
        const id = `lvl-${level}`;
        const label = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = id;
        cb.checked = true;
        cb.dataset.level = level;
        cb.addEventListener('change', renderTable);
        label.appendChild(cb);
        const span = document.createElement('span');
        span.textContent = level;
        label.appendChild(span);
        filterLevelsContainer.appendChild(label);
      });
    }

    function renderTable() {
      if (!allEvents.length) {
        tableContainer.innerHTML = '<div class="no-data">Aucun log chargé.</div>';
        return;
      }

      // Niveaux cochés
      const checkedLevels = new Set(
        Array.from(filterLevelsContainer.querySelectorAll('input[type="checkbox"]'))
          .filter(cb => cb.checked)
          .map(cb => cb.dataset.level)
      );

      // Filtre texte
      const textFilter = (filterTextInput.value || '').toLowerCase();

      let rows = allEvents.filter(ev => checkedLevels.has(ev.level));

      if (textFilter) {
        rows = rows.filter(ev =>
          ev.raw.toLowerCase().includes(textFilter)
        );
      }

      // Tri simple : par colonne (level, file, Trans, Date, etc.)
      rows.sort((a, b) => compareEvents(a, b, currentSort));

      // Construction du tableau
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const headerRow = document.createElement('tr');
      const columns = [
        { key: 'level', label: 'Type' },
        { key: 'file', label: 'Fichier' },
        { key: 'Trans', label: 'Trans' },
        { key: 'Term', label: 'Term' },
        { key: 'Date', label: 'Date' },
        { key: 'StationID', label: 'Station' },
        { key: 'ArticleID', label: 'Article' },
        { key: 'Qté', label: 'Qté' },
        { key: 'Montant', label: 'Montant' },
        { key: 'Tax', label: 'Taxe' },
        { key: 'Tank', label: 'Tank' },
        { key: 'raw', label: 'Ligne brute' }
      ];

      columns.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col.label;
        th.dataset.column = col.key;
        th.addEventListener('click', () => {
          if (currentSort.column === col.key) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort.column = col.key;
            currentSort.direction = 'asc';
          }
          renderTable();
        });
        if (currentSort.column === col.key) {
          th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);

      if (!rows.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = columns.length;
        td.className = 'no-data';
        td.textContent = 'Aucune ligne ne correspond aux filtres.';
        tr.appendChild(td);
        tbody.appendChild(tr);
      } else {
        rows.forEach(ev => {
          const tr = document.createElement('tr');

          const tdLevel = document.createElement('td');
          tdLevel.innerHTML = `<span class="level level-${ev.level}">${ev.level}</span>`;
          tr.appendChild(tdLevel);

          const tdFile = document.createElement('td');
          tdFile.textContent = ev.file;
          tr.appendChild(tdFile);

          const tdTrans = document.createElement('td');
          tdTrans.textContent = ev.fields['Trans'] || '';
          tr.appendChild(tdTrans);

          const tdTerm = document.createElement('td');
          tdTerm.textContent = ev.fields['Term'] || ev.fields['TerminalID'] || '';
          tr.appendChild(tdTerm);

          const tdDate = document.createElement('td');
          tdDate.textContent = ev.fields['Date'] || '';
          tr.appendChild(tdDate);

          const tdStation = document.createElement('td');
          tdStation.textContent = ev.fields['StationID'] || '';
          tr.appendChild(tdStation);

          const tdArticle = document.createElement('td');
          tdArticle.textContent = ev.fields['ArticleID'] || '';
          tr.appendChild(tdArticle);

          const tdQty = document.createElement('td');
          tdQty.textContent = ev.fields['Qté'] || ev.fields['Qty'] || '';
          tr.appendChild(tdQty);

          const tdAmount = document.createElement('td');
          tdAmount.textContent = ev.fields['Montant'] || ev.fields['Amount'] || '';
          tr.appendChild(tdAmount);

          const tdTax = document.createElement('td');
          tdTax.textContent = ev.fields['Tax'] || ev.fields['Taxrate'] || '';
          tr.appendChild(tdTax);

          const tdTank = document.createElement('td');
          tdTank.textContent = ev.fields['Tank'] || ev.fields['TankNumber'] || '';
          tr.appendChild(tdTank);

          const tdRaw = document.createElement('td');
          tdRaw.className = 'raw';
          tdRaw.textContent = ev.raw;
          tr.appendChild(tdRaw);

          tbody.appendChild(tr);
        });
      }

      table.appendChild(thead);
      table.appendChild(tbody);
      tableContainer.innerHTML = '';
      tableContainer.appendChild(table);
    }

    function compareEvents(a, b, sort) {
      const col = sort.column;
      const dir = sort.direction === 'asc' ? 1 : -1;

      const get = (ev) => {
        if (col === 'level') return ev.level;
        if (col === 'file') return ev.file;
        if (col === 'raw') return ev.raw;
        if (col === 'Trans') return ev.fields['Trans'] || '';
        if (col === 'Term') return ev.fields['Term'] || ev.fields['TerminalID'] || '';
        if (col === 'Date') return ev.fields['Date'] || '';
        if (col === 'StationID') return ev.fields['StationID'] || '';
        if (col === 'ArticleID') return ev.fields['ArticleID'] || '';
        if (col === 'Qté') return ev.fields['Qté'] || ev.fields['Qty'] || '';
        if (col === 'Montant') return ev.fields['Montant'] || ev.fields['Amount'] || '';
        if (col === 'Tax') return ev.fields['Tax'] || ev.fields['Taxrate'] || '';
        if (col === 'Tank') return ev.fields['Tank'] || ev.fields['TankNumber'] || '';
        return '';
      };

      const va = get(a) || '';
      const vb = get(b) || '';

      // tentative de tri numérique si possible
      const na = parseFloat(va.replace(',', '.'));
      const nb = parseFloat(vb.replace(',', '.'));
      if (!isNaN(na) && !isNaN(nb)) {
        if (na < nb) return -1 * dir;
        if (na > nb) return 1 * dir;
        return 0;
      }

      // tri texte
      if (va < vb) return -1 * dir;
      if (va > vb) return 1 * dir;
      return 0;
    }

    // initialisation du tri par défaut
    currentSort.column = 'level';
    currentSort.direction = 'asc';
    </script>
</body>
</html>
